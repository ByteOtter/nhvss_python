import os


def vulnerability_scan(file_name):

    # os.system("cd ")
    # os.system("ls /usr/share/nmap/scripts |greb -e " + '"vulners"')
    os.system("sudo nmap --script-updatedb")
    os.system("cd " + os.getcwd())
    os.system("clear")

    response = []
    file_name2 = "scan_history/" + file_name
    file_list = []
    with open(file_name2, "r") as file:
        for line in file:
            file_list.append(line)
        file.close()

    for line in file:
        line = line.split(" | ")[0]
        ip = line.strip()
        print("Scanning " + ip + " for vulnerabilities")

        for line in os.popen("sudo nmap -sS -A -O --script vulners " + ip):
            print(line.strip())
            response.append(line)

        if "Host seems down" in response:
            print(ip + " is down")
        else:
            os.system(
                "mkdir -p "
                + os.getcwd()
                + "/scanned_hosts/"
                + file_name.split("_hosts.txt")[0]
                + "/"
            )
            new_folder = (
                os.getcwd() + "/scanned_hosts/" + file_name.split("_hosts.txt")[0] + "/"
            )
            with open(new_folder + "scanned_hosts/" + ip + ".txt", "w") as file:
                for i in response:
                    file.writelines(i)

                print(ip + " is up")


# This call to the function vulnerability_scan() is here for debugging purposes. Uncomment it if needed.
# path = os.getcwd()
# vulnerability_scan(path)
